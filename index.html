<script>
  const FIELD_TEXT = 'Customer Name'; // ajústalo si vemos otro nombre
  const FIELD_SHIP = 'Ship Mode';

  const viz = document.getElementById('tableau-viz');

  viz.addEventListener('firstinteractive', async () => {
    console.log('Viz listo');
    const ws = await viz.getActiveSheet();
    console.log('Sheet type:', ws.getSheetType && ws.getSheetType());

    // Intenta obtener columnas de resumen para ver nombres exactos
    try {
      const summary = await ws.getSummaryDataAsync({ maxRows: 5 });
      const cols = summary.getColumns().map(c => c.getFieldName());
      console.log('Columnas según summary:', cols);
    } catch (e) {
      console.warn('No pudo traer summary:', e);
    }

    // Lista de filtros presentes y aplicables
    try {
      const filters = await ws.getFiltersAsync();
      console.log('Filtros existentes en la hoja:', filters.map(f => f.getFieldName()));
    } catch (e) {
      console.warn('No pudo listar filtros:', e);
    }
  });

  async function getSheet() {
    return await viz.getActiveSheet();
  }

  async function applyFilters() {
    try {
      const ws = await getSheet();
      const q  = document.getElementById('q').value.trim();
      const sm = document.getElementById('ship').value;

      console.log('Aplicando...', { q, sm });

      // Limpia con cuidado: si el campo no existe, registra y sigue
      for (const f of [FIELD_TEXT, FIELD_SHIP]) {
        try { await ws.clearFilterAsync(f); } catch (e) { console.warn('clearFilter falló para', f, e?.message); }
      }

      if (sm) {
        await ws.applyFilterAsync(FIELD_SHIP, sm, 'REPLACE')
          .then(()=>console.log('OK Ship Mode'))
          .catch(e=>{ console.error('Ship Mode error', e); throw e; });
      }

      if (q) {
        await ws.applyFilterAsync(FIELD_TEXT, { operator: 'CONTAINS', values: [q] }, 'REPLACE')
          .then(()=>console.log('OK Customer Name'))
          .catch(e=>{ console.error('Customer Name error', e); throw e; });
      }

      console.log('Hecho');
    } catch (e) {
      console.error('applyFilters error:', e);
      alert('No se pudieron aplicar filtros. Abre la consola y dime el mensaje que aparece.');
    }
  }

  async function clearAll() {
    const ws = await getSheet();
    for (const f of [FIELD_TEXT, FIELD_SHIP]) {
      try { await ws.clearFilterAsync(f); } catch {}
    }
    document.getElementById('q').value = '';
    document.getElementById('ship').value = '';
    console.log('Limpio');
  }

  document.getElementById('apply').addEventListener('click', applyFilters);
  document.getElementById('clear').addEventListener('click', clearAll);
  document.getElementById('q').addEventListener('keyup', e => { if (e.key === 'Enter') applyFilters(); });
</script>
