<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Search sencillo: Customer Name + Ship Mode</title>
  <!-- Script de Embedding (tu misma región) -->
  <script type="module" src="https://us-east-1.online.tableau.com/javascripts/api/tableau.embedding.3.latest.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:16px; }
    .controls { display:flex; flex-wrap: wrap; gap:10px; margin-bottom:10px; }
    input, select, button { padding: 8px 10px; }
    #tableau-viz { width: 100%; height: 78vh; border: 1px solid #ddd; border-radius: 6px; }
  </style>
</head>
<body>
  <h3>Search sencillo: Customer Name + Ship Mode</h3>

  <div class="controls">
    <input id="q" placeholder="Buscar en Customer Name (contains)..." />
    <select id="ship">
      <option value="">Ship Mode (todos)</option>
      <option>Standard Class</option>
      <option>Second Class</option>
      <option>First Class</option>
      <option>Same Day</option>
    </select>
    <button id="apply">Aplicar</button>
    <button id="clear">Limpiar</button>
  </div>

  <!-- Tu viz embebido (exacto) -->
  <tableau-viz
    id="tableau-viz"
    src="https://us-east-1.online.tableau.com/t/jacastellanos01-361c41eb62/views/Prueba_17598763501720/Sheet1"
    width="1263"
    height="615"
    hide-tabs
    toolbar="bottom">
  </tableau-viz>

  <script>
    // Nombres exactos de campos en tu datasource
    const FIELD_TEXT = 'Customer Name';
    const FIELD_SHIP = 'Ship Mode';

    const vizEl = document.getElementById('tableau-viz');
    let vizInstance = null; // instancia real del viz (no el web component)

    // Espera a que el web component tenga la instancia disponible
    async function waitForVizInstance(timeoutMs = 8000) {
      const start = Date.now();
      while (!vizEl.viz) {
        await new Promise(r => setTimeout(r, 100));
        if (Date.now() - start > timeoutMs) {
          throw new Error('Timeout esperando viz');
        }
      }
      return vizEl.viz;
    }

    // Cuando el viz esté listo, captura la instancia real
    vizEl.addEventListener('firstinteractive', async () => {
      try {
        vizInstance = await waitForVizInstance();
        console.log('Viz listo. Instancia OK:', !!vizInstance);
      } catch (e) {
        console.error('No se pudo obtener instancia del viz:', e);
      }
    });

    function getWorksheet() {
      if (!vizInstance) throw new Error('Viz aún no inicializado');
      const active = vizInstance.workbook.activeSheet;
      // Si fuese un dashboard, elegiríamos la worksheet:
      // if (active.sheetType === 'dashboard') {
      //   return active.worksheets.find(w => w.name === 'Sheet 1') || active.worksheets[0];
      // }
      return active; // es hoja
    }

    async function applyFilters() {
      try {
        if (!vizInstance) vizInstance = await waitForVizInstance(); // fallback por si el usuario clickeó muy rápido
        const ws = getWorksheet();
        const q  = document.getElementById('q').value.trim();
        const sm = document.getElementById('ship').value;

        console.log('Aplicando...', { q, sm });

        // Limpia previos (ignora errores si no existían)
        try { await ws.clearFilterAsync(FIELD_TEXT); } catch {}
        try { await ws.clearFilterAsync(FIELD_SHIP); } catch {}

        // Aplica filtros
        if (sm) {
          await ws.applyFilterAsync(
            FIELD_SHIP,
            sm,
            window.tableau.FilterUpdateType.REPLACE
          );
        }
        if (q) {
          await ws.applyFilterAsync(
            FIELD_TEXT,
            { operator: window.tableau.FilterOperator.CONTAINS, values: [q] },
            window.tableau.FilterUpdateType.REPLACE
          );
        }

        console.log('Filtros aplicados', { q, sm });
      } catch (e) {
        console.error('applyFilters error:', e);
        alert('No se pudieron aplicar filtros. Revisa consola.');
      }
    }

    async function clearAll() {
      try {
        if (!vizInstance) vizInstance = await waitForVizInstance();
        const ws = getWorksheet();
        try { await ws.clearFilterAsync(FIELD_TEXT); } catch {}
        try { await ws.clearFilterAsync(FIELD_SHIP); } catch {}
        document.getElementById('q').value = '';
        document.getElementById('ship').value = '';
        console.log('Limpio');
      } catch (e) {
        console.error(e);
      }
    }

    document.getElementById('apply').addEventListener('click', applyFilters);
    document.getElementById('clear').addEventListener('click', clearAll);
    document.getElementById('q').addEventListener('keyup', e => { if (e.key === 'Enter') applyFilters(); });
  </script>
</body>
</html>
