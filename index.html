<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tableau Embed + Search</title>
  <script type="module" src="https://public.tableau.com/javascripts/api/tableau.embedding.3.latest.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:16px; }
    #viz { width: 100%; height: 78vh; border: 1px solid #ddd; border-radius: 6px; }
    .controls { display:flex; flex-wrap: wrap; gap:12px; padding:10px 0; align-items: center; }
    input, select, button { padding: 8px 10px; }
    button:disabled { opacity: .5; }
  </style>
</head>
<body>
  <h3>Demo: Tableau + Search</h3>

  <div class="controls">
    <input id="seg" placeholder="Segment (ej: Consumer)" />
    <select id="cat">
      <option value="">Todas las categorías</option>
      <option>Furniture</option>
      <option>Office Supplies</option>
      <option>Technology</option>
    </select>
    <button id="searchBtn" disabled>Aplicar</button>
    <button id="clearBtn" disabled>Limpiar</button>
  </div>

  <tableau-viz
    id="viz"
    hide-tabs
    toolbar="bottom"
    src="https://us-east-1.online.tableau.com/t/jacastellanos01-361c41eb62/views/Prueba_17598763501720/Sheet1">
  </tableau-viz>

  <script>
    const FIELD_SEGMENT = 'Segment';
    const FIELD_CATEGORY = 'Category';

    const vizEl = document.getElementById('viz');
    const btnApply = document.getElementById('searchBtn');
    const btnClear = document.getElementById('clearBtn');

    vizEl.addEventListener('firstinteractive', async () => {
      console.log('Viz ready');

      // Habilita botones
      btnApply.disabled = false;
      btnClear.disabled = false;

      // Log para ver tipo de hoja y campos
      const sheet = await vizEl.getActiveSheet();
      console.log('Sheet type:', sheet.getSheetType && sheet.getSheetType());
      try {
        const summary = await sheet.getSummaryDataAsync({ maxRows: 5 });
        console.log('Columns:', summary.getColumns().map(c => c.getFieldName()));
      } catch (e) {
        console.warn('No summary yet:', e);
      }
    });

    async function getSheet() {
      const sheet = await vizEl.getActiveSheet();
      if (sheet.getSheetType && sheet.getSheetType() === 'dashboard') {
        const ws = await sheet.getWorksheets();
        console.log('Dashboard worksheets:', ws.map(w => w.getName()));
        return ws[0]; // ajusta si usas dashboard
      }
      return sheet; // hoja única (Sheet 1)
    }

    async function applyFilters() {
      try {
        const ws = await getSheet();
        const seg = document.getElementById('seg').value.trim();
        const cat = document.getElementById('cat').value;

        // Limpia primero
        await ws.clearFilterAsync(FIELD_SEGMENT).catch(()=>{});
        await ws.clearFilterAsync(FIELD_CATEGORY).catch(()=>{});

        if (cat) {
          await ws.applyFilterAsync(FIELD_CATEGORY, cat, 'REPLACE');
        }
        if (seg) {
          // Segment tiene valores exactos: Consumer, Corporate, Home Office
          await ws.applyFilterAsync(FIELD_SEGMENT, seg, 'REPLACE');
        }
        console.log('Applied. seg=', seg, 'cat=', cat);
      } catch (e) {
        console.error('applyFilters error', e);
        alert('Error aplicando filtros. Revisa consola.');
      }
    }

    async function clearAll() {
      const ws = await getSheet();
      await Promise.all([
        ws.clearFilterAsync(FIELD_SEGMENT).catch(()=>{}),
        ws.clearFilterAsync(FIELD_CATEGORY).catch(()=>{})
      ]);
      document.getElementById('seg').value = '';
      document.getElementById('cat').value = '';
      console.log('Cleared');
    }

    btnApply.addEventListener('click', applyFilters);
    btnClear.addEventListener('click', clearAll);
  </script>
</body>
</html>
